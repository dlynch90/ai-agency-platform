# Mitmproxy Configuration for API Smoke Testing
# Network proxy setup for GraphQL federation testing

# Server Configuration
listen_host: 0.0.0.0
listen_port: 8080

# SSL Configuration
ssl_insecure: true
ssl_verify_upstream_cert: false

# Upstream Servers
upstream:
  graphql_gateway: "http://localhost:4000"
  api_server: "http://localhost:3000"
  auth_service: "http://localhost:4001"

# Routing Rules
routes:
  - match: "^/graphql"
    target: "{{ upstream.graphql_gateway }}"
    rewrite: "/graphql"

  - match: "^/api/v1"
    target: "{{ upstream.api_server }}"
    rewrite: "/api/v1"

  - match: "^/auth"
    target: "{{ upstream.auth_service }}"
    rewrite: "/auth"

# Request/Response Modifications
modifications:
  # Add common headers
  request_headers:
    - "X-API-Key: test-key"
    - "X-Client-Version: 1.0.0"
    - "User-Agent: AI-Agency-Test/1.0"

  # CORS headers for development
  response_headers:
    - "Access-Control-Allow-Origin: *"
    - "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS"
    - "Access-Control-Allow-Headers: Content-Type, Authorization, X-API-Key"

# Logging Configuration
logging:
  level: info
  format: json
  file: logs/mitmproxy.log

# Addons
addons:
  - request_logger
  - response_validator
  - smoke_test_runner

# Smoke Test Configuration
smoke_tests:
  enabled: true
  interval: 60  # seconds
  timeout: 30   # seconds

  tests:
    # GraphQL Federation Health Check
    - name: "GraphQL Federation Health"
      method: POST
      url: "/graphql"
      headers:
        Content-Type: "application/json"
      body: |
        {
          "query": "{ _service { sdl } }"
        }
      expected_status: 200
      expected_body_contains: "schema"

    # Authentication Service Health
    - name: "Auth Service Health"
      method: GET
      url: "/auth/health"
      expected_status: 200
      expected_body_contains: "ok"

    # API Server Health
    - name: "API Server Health"
      method: GET
      url: "/api/v1/health"
      expected_status: 200
      expected_body_contains: "healthy"

    # Database Connectivity
    - name: "Database Connectivity"
      method: GET
      url: "/api/v1/db/health"
      expected_status: 200
      expected_body_contains: "connected"

# Performance Monitoring
performance:
  enabled: true
  metrics:
    - response_time
    - throughput
    - error_rate
  thresholds:
    response_time_max: 5000  # 5 seconds
    error_rate_max: 0.05     # 5%

# Security Testing
security:
  enabled: true
  checks:
    - sql_injection
    - xss
    - csrf
    - auth_bypass

# Load Testing
load_test:
  enabled: false
  concurrency: 10
  duration: 60  # seconds
  ramp_up: 10   # seconds

# WebSocket Support
websocket:
  enabled: true
  ping_interval: 30

# File Upload Handling
uploads:
  max_size: 100MB
  allowed_types:
    - "image/*"
    - "application/json"
    - "text/*"
    - "application/pdf"