# Lefthook configuration for automated git workflow management
# Enforces vendor compliance, architecture rules, and code quality

pre-commit:
  parallel: true
  commands:
    # Vendor compliance check - ensure no custom implementations
    vendor-compliance:
      run: |
        echo "ğŸ” Checking vendor compliance..."
        # Check for common custom patterns that violate rules, but exclude dependencies
        source_files=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.sh" \) -not -path "*/node_modules/*" -not -path "*/.pixi/*" -not -path "*/__pycache__/*" -not -path "*/.git/*" | head -20)
        if [ -n "$source_files" ]; then
          console_log_files=$(echo "$source_files" | xargs grep -l "console\.log" 2>/dev/null || true)
          if [ -n "$console_log_files" ]; then
            echo "âš ï¸ WARNING: console.log found in source files (consider using vendor logging)"
            echo "Files with console.log:"
            echo "$console_log_files"
            # Don't fail the build for now, just warn
          fi
        fi
        echo "âœ… Vendor compliance check completed"

    # Architecture enforcement - no loose files in root
    architecture-check:
      run: |
        echo "ğŸ—ï¸ Checking architecture compliance..."
        # Check for loose files in root that violate directory structure
        loose_files=$(find . -maxdepth 1 -type f -not -path './.git*' -not -name ".gitignore" -not -name "README.md" -not -name "package.json" -not -name "lefthook.yml" -not -name ".editorconfig" -not -name "tsconfig.json" -not -name "vitest.config.*" -not -name "turbo.json" -not -name "pixi.toml" -not -name "pixi.lock" -not -name "pyproject.toml" -not -name "pnpm-workspace.yaml" -not -name "docker-compose.yml" -not -name "Dockerfile" | wc -l)
        if [ "$loose_files" -gt 0 ]; then
          echo "âŒ ERROR: Loose files found in root directory (violate architecture rules)"
          find . -maxdepth 1 -type f -not -path './.git*' -not -name ".gitignore" -not -name "README.md" -not -name "package.json" -not -name "lefthook.yml"
          exit 1
        fi
        echo "âœ… Architecture check passed"

    # MCP server health check
    mcp-health-check:
      run: |
        echo "ğŸ”§ Checking MCP server health..."
        # Check if critical MCP servers are accessible
        if command -v node >/dev/null 2>&1; then
          if ! timeout 5 node -e "console.log('Node.js OK')" >/dev/null 2>&1; then
            echo "âš ï¸ WARNING: Node.js runtime issues detected"
          fi
        fi
        if command -v python3 >/dev/null 2>&1; then
          if ! timeout 5 python3 -c "print('Python OK')" >/dev/null 2>&1; then
            echo "âš ï¸ WARNING: Python runtime issues detected"
          fi
        fi
        echo "âœ… MCP health check completed"

post-commit:
  commands:
    # Automated cleanup and optimization
    repository-maintenance:
      run: |
        echo "ğŸ§¹ Running post-commit maintenance..."
        # Clean any temporary files that might have been created
        find . -name "*.tmp" -type f -delete 2>/dev/null || true
        find . -name "*.bak" -type f -delete 2>/dev/null || true
        echo "âœ… Post-commit maintenance completed"

pre-push:
  commands:
    # Final validation before push
    final-validation:
      run: |
        echo "ğŸš€ Running pre-push validation..."
        # Check if repository is in clean state
        if [ -n "$(git status --porcelain)" ]; then
          echo "âš ï¸ WARNING: Repository has uncommitted changes"
        fi
        # Validate critical files exist
        if [ ! -f "package.json" ]; then
          echo "âŒ ERROR: package.json missing"
          exit 1
        fi
        echo "âœ… Pre-push validation completed"