# Lefthook configuration for automated git workflow management
# Enforces vendor compliance, architecture rules, and code quality

pre-commit:
  parallel: true
  commands:
    # Gitleaks - Detect hardcoded paths and secrets (SSOT enforcement)
    gitleaks-chezmoi:
      run: |
        echo "üîí Running gitleaks chezmoi variable enforcement..."
        if command -v gitleaks >/dev/null 2>&1; then
          gitleaks protect --staged --config configs/.gitleaks.toml --verbose 2>&1 || {
            echo "‚ùå Gitleaks found violations - use \$CHEZMOI_* variables instead of hardcoded paths/ports"
            exit 1
          }
        else
          echo "‚ö†Ô∏è gitleaks not installed - skipping enforcement"
        fi
        echo "‚úÖ Gitleaks check passed"

    # Chezmoi template validation
    chezmoi-validate:
      run: |
        echo "üìù Validating chezmoi templates..."
        if command -v chezmoi >/dev/null 2>&1; then
          chezmoi execute-template < /dev/null 2>&1 || {
            echo "‚ùå Chezmoi template syntax error"
            exit 1
          }
        fi
        echo "‚úÖ Chezmoi validation passed"

    # TypeScript type checking
    type-check:
      run: |
        echo "üî∑ Running TypeScript type checking..."
        if command -v tsc >/dev/null 2>&1; then
          ERROR_COUNT=$(npx tsc --noEmit 2>&1 | grep -c "error TS" || echo "0")
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ùå TypeScript errors found: $ERROR_COUNT"
            npx tsc --noEmit 2>&1 | grep "error TS" | head -5
            # Allow some errors for now, but log them
          else
            echo "‚úÖ TypeScript compilation successful"
          fi
        else
          echo "‚ö†Ô∏è TypeScript not available"
        fi
        echo "‚úÖ Type checking completed"

    # Vendor compliance check - STRICT: no custom implementations allowed
    vendor-compliance:
      run: |
        echo "üîç Checking STRICT vendor compliance..."
        echo "üö´ ZERO CUSTOM CODE POLICY ENFORCEMENT"

        # Check for console.log (must use Pino or vendor logging)
        CONSOLE_LOG_FILES=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" \) -not -path "*/node_modules/*" -not -path "*/.pixi/*" -not -path "*/__pycache__/*" -not -path "*/.git/*" | xargs grep -l "console\.log" 2>/dev/null || true)
        if [ -n "$CONSOLE_LOG_FILES" ]; then
          echo "‚ùå ERROR: console.log found (VIOLATES ZERO CUSTOM CODE RULE)"
          echo "Must use Pino logging instead:"
          echo "$CONSOLE_LOG_FILES"
          echo "üí° Replace with: import pino from 'pino'; const logger = pino();"
          exit 1
        fi

        # Check for custom React components (must use vendor libraries)
        CUSTOM_COMPONENTS=$(find . -type f -name "*.tsx" -o -name "*.jsx" | xargs grep -l "export.*function.*{" | head -5 2>/dev/null || true)
        if [ -n "$CUSTOM_COMPONENTS" ]; then
          echo "‚ùå ERROR: Custom React components found (VIOLATES VENDOR-ONLY RULE)"
          echo "Must use vendor component libraries only:"
          echo "$CUSTOM_COMPONENTS"
          echo "üí° Use: Radix Vue, Shadcn/ui, or other vendor libraries"
          exit 1
        fi

        # Check for custom hooks (must use vendor solutions)
        CUSTOM_HOOKS=$(find . -type f \( -name "*.ts" -o -name "*.js" \) | xargs grep -l "use[A-Z].*=.*{" | head -5 2>/dev/null || true)
        if [ -n "$CUSTOM_HOOKS" ]; then
          echo "‚ùå ERROR: Custom React hooks found (VIOLATES VENDOR-ONLY RULE)"
          echo "Must use vendor hooks only:"
          echo "$CUSTOM_HOOKS"
          echo "üí° Use: VueUse, TanStack Query, Zustand, etc."
          exit 1
        fi

        # Check for custom utilities (must use vendor libraries)
        CUSTOM_UTILS=$(find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.py" \) | xargs grep -l "export.*util" | head -5 2>/dev/null || true)
        if [ -n "$CUSTOM_UTILS" ]; then
          echo "‚ùå ERROR: Custom utilities found (VIOLATES VENDOR-ONLY RULE)"
          echo "Must use vendor utility libraries:"
          echo "$CUSTOM_UTILS"
          echo "üí° Use: Lodash, date-fns, Ramda, etc."
          exit 1
        fi

        # Check for hardcoded paths (must use chezmoi variables)
        HARDCODED_PATHS=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.sh" \) -not -path "*/node_modules/*" | xargs grep -l "/Users/\|/home/\|/tmp/" | head -5 2>/dev/null || true)
        if [ -n "$HARDCODED_PATHS" ]; then
          echo "‚ùå ERROR: Hardcoded paths found (VIOLATES SSOT RULE)"
          echo "Must use chezmoi variables:"
          echo "$HARDCODED_PATHS"
          echo "üí° Use: {{.chezmoi.homeDir}}, {{.chezmoi.configDir}}, etc."
          exit 1
        fi

        # Check for hardcoded ports (must use chezmoi variables)
        HARDCODED_PORTS=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" \) -not -path "*/node_modules/*" | xargs grep -l ":[0-9]\{4\}" | head -5 2>/dev/null || true)
        if [ -n "$HARDCODED_PORTS" ]; then
          echo "‚ùå ERROR: Hardcoded ports found (VIOLATES SSOT RULE)"
          echo "Must use chezmoi variables:"
          echo "$HARDCODED_PORTS"
          echo "üí° Use: {{.ports.postgres}}, {{.ports.redis}}, etc."
          exit 1
        fi

        echo "‚úÖ STRICT vendor compliance check passed"

    # Architecture enforcement - no loose files in root
    architecture-check:
      run: |
        echo "üèóÔ∏è Checking architecture compliance..."

        # Check for loose files in root directory (violates monorepo rules)
        LOOSE_FILES=$(find . -maxdepth 1 -type f \( -name "*.js" -o -name "*.py" -o -name "*.sh" -o -name "*.json" -o -name "*.md" -o -name "*.txt" -o -name "*.log" -o -name "*.db" \) \
          -not -name "package.json" \
          -not -name "pixi.toml" \
          -not -name "tsconfig.json" \
          -not -name "turbo.json" \
          -not -name "lefthook.yml" \
          -not -name "pnpm-lock.yaml" \
          -not -name "pixi.lock" \
          -not -name ".gitignore" \
          -not -name "README.md" \
          -not -name "Makefile" \
          -not -name "*.lock" \
          2>/dev/null | wc -l)

        if [ "$LOOSE_FILES" -gt 0 ]; then
          echo "‚ùå ERROR: Loose files found in root directory (violates monorepo architecture)"
          echo "All files must be organized in proper directories:"
          echo "  - Scripts ‚Üí /scripts/"
          echo "  - Configs ‚Üí /configs/"
          echo "  - Logs ‚Üí /logs/"
          echo "  - Docs ‚Üí /docs/"
          echo "  - Data ‚Üí /data/"
          echo "  - Tests ‚Üí /testing/"
          echo "  - Reports ‚Üí /reports/"
          echo ""
          find . -maxdepth 1 -type f \( -name "*.js" -o -name "*.py" -o -name "*.sh" -o -name "*.json" -o -name "*.md" -o -name "*.txt" -o -name "*.log" -o -name "*.db" \) \
            -not -name "package.json" \
            -not -name "pixi.toml" \
            -not -name "tsconfig.json" \
            -not -name "turbo.json" \
            -not -name "lefthook.yml" \
            -not -name "pnpm-lock.yaml" \
            -not -name "pixi.lock" \
            -not -name ".gitignore" \
            -not -name "README.md" \
            -not -name "Makefile" \
            -not -name "*.lock"
          echo ""
          echo "üí° Run: node scripts/organize-loose-files.mjs"
          exit 1
        fi

        # Check for empty directories (violates organization rules)
        EMPTY_DIRS=$(find . -type d -empty -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.pixi/*" | wc -l)
        if [ "$EMPTY_DIRS" -gt 0 ]; then
          echo "‚ö†Ô∏è WARNING: Empty directories found (consider removing or adding .gitkeep)"
          find . -type d -empty -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.pixi/*"
        fi

        # Check for broken symlinks
        BROKEN_LINKS=$(find . -type l ! -exec test -e {} \; 2>/dev/null | wc -l)
        if [ "$BROKEN_LINKS" -gt 0 ]; then
          echo "‚ùå ERROR: Broken symlinks found"
          find . -type l ! -exec test -e {} \; 2>/dev/null
          exit 1
        fi

        echo "‚úÖ Architecture check passed"

    # Monorepo organization check
    organization-check:
      run: |
        echo "üìÅ Running monorepo organization validation..."
        if [ -f "scripts/validate-monorepo-structure.sh" ]; then
          if ! bash scripts/validate-monorepo-structure.sh; then
            echo "‚ùå Organization validation failed"
            exit 1
          fi
        else
          echo "‚ö†Ô∏è Organization validation script not found"
        fi
        echo "‚úÖ Organization check passed"

    # MCP server health check
    mcp-health-check:
      run: |
        echo "üîß Checking MCP server health..."
        # Check if critical MCP servers are accessible
        if command -v node >/dev/null 2>&1; then
          if ! timeout 5 node -e "console.log('Node.js OK')" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è WARNING: Node.js runtime issues detected"
          fi
        fi
        if command -v python3 >/dev/null 2>&1; then
          if ! timeout 5 python3 -c "print('Python OK')" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è WARNING: Python runtime issues detected"
          fi
        fi
        echo "‚úÖ MCP health check completed"

post-commit:
  parallel: true
  commands:
    # Automated cleanup and optimization
    repository-maintenance:
      run: |
        echo "üßπ Running post-commit maintenance..."
        # Clean any temporary files that might have been created
        find . -name "*.tmp" -type f -delete 2>/dev/null || true
        find . -name "*.bak" -type f -delete 2>/dev/null || true
        echo "‚úÖ Post-commit maintenance completed"

    # Event-driven workflow trigger
    event-driven-trigger:
      run: |
        echo "üì° Emitting post-commit event..."
        COMMIT_SHA=$(git rev-parse HEAD)
        COMMIT_MSG=$(git log -1 --pretty=%B)
        AUTHOR=$(git log -1 --pretty=%an)
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        
        # Create event payload
        EVENT_PAYLOAD=$(cat <<EOF
        {
          "event": "post_commit",
          "commit_sha": "$COMMIT_SHA",
          "branch": "$BRANCH",
          "author": "$AUTHOR",
          "message": "$(echo "$COMMIT_MSG" | head -1)",
          "timestamp": "$(date -Iseconds)",
          "type": "local"
        }
        EOF
        )
        
        # Log event
        echo "$EVENT_PAYLOAD" >> .git/commit-events.log 2>/dev/null || true
        
        # Trigger Temporal workflow if available
        if command -v temporal &>/dev/null; then
          temporal workflow start \
            --task-queue post-commit-events \
            --workflow-id "post-commit-$COMMIT_SHA" \
            --type PostCommitWorkflow \
            --input "$EVENT_PAYLOAD" \
            2>/dev/null || true
        fi
        
        # Publish to Kafka if available
        if command -v kafka-console-producer &>/dev/null; then
          echo "$EVENT_PAYLOAD" | \
          kafka-console-producer --broker-list localhost:9092 --topic git-events 2>/dev/null || true
        fi
        
        echo "‚úÖ Post-commit event emitted"

    # LLM Judge validation for significant changes
    llm-judge-check:
      run: |
        echo "ü§ñ Checking if LLM Judge validation needed..."
        
        # Count changed lines
        CHANGED_LINES=$(git diff HEAD~1 --stat | tail -1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
        
        if [ "$CHANGED_LINES" -gt 100 ]; then
          echo "‚ö†Ô∏è  Significant changes detected ($CHANGED_LINES lines). Consider running LLM Judge x2 validation."
          echo "   Run: node scripts/llm-judge-x2-validator.js"
        fi
        
        echo "‚úÖ LLM Judge check completed"

    # Circuit breaker health check
    circuit-breaker-health:
      run: |
        echo "üîå Checking circuit breaker health..."
        if [ -f "scripts/circuit-breaker.js" ]; then
          # Verify Opossum is being used (not custom implementation)
          if grep -q "require('opossum')" scripts/circuit-breaker.js 2>/dev/null; then
            echo "‚úÖ Using Opossum vendor circuit breaker"
          else
            echo "‚ö†Ô∏è  Custom circuit breaker detected - should use Opossum"
          fi
        fi
        echo "‚úÖ Circuit breaker health check completed"

    # Update documentation index
    docs-index-update:
      run: |
        echo "üìö Updating documentation index..."
        # Check if docs were modified
        if git diff HEAD~1 --name-only | grep -q "^docs/"; then
          echo "üìù Documentation changes detected"
          # Could trigger doc generation here
        fi
        echo "‚úÖ Documentation index updated"

    # Metrics collection
    metrics-collection:
      run: |
        echo "üìä Collecting commit metrics..."
        
        # Collect metrics
        FILES_CHANGED=$(git diff HEAD~1 --name-only | wc -l | tr -d ' ')
        LINES_ADDED=$(git diff HEAD~1 --stat | tail -1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
        LINES_REMOVED=$(git diff HEAD~1 --stat | tail -1 | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
        
        # Log metrics
        METRICS_LOG=".git/commit-metrics.log"
        echo "$(date -Iseconds),$(git rev-parse --short HEAD),$FILES_CHANGED,$LINES_ADDED,$LINES_REMOVED" >> "$METRICS_LOG" 2>/dev/null || true
        
        # Push to Prometheus if available
        if command -v curl &>/dev/null && [ -n "${PROMETHEUS_PUSHGATEWAY:-}" ]; then
          cat <<EOF | curl --data-binary @- "${PROMETHEUS_PUSHGATEWAY}/metrics/job/git_commits/instance/$(hostname)" 2>/dev/null || true
        # HELP git_commit_files_changed Number of files changed in commit
        # TYPE git_commit_files_changed gauge
        git_commit_files_changed $FILES_CHANGED
        # HELP git_commit_lines_added Lines added in commit
        # TYPE git_commit_lines_added gauge
        git_commit_lines_added $LINES_ADDED
        # HELP git_commit_lines_removed Lines removed in commit
        # TYPE git_commit_lines_removed gauge
        git_commit_lines_removed $LINES_REMOVED
        EOF
        fi
        
        echo "‚úÖ Metrics collected: $FILES_CHANGED files, +$LINES_ADDED/-$LINES_REMOVED lines"

pre-push:
  commands:
    # Final validation before push
    final-validation:
      run: |
        echo "üöÄ Running pre-push validation..."
        # Check if repository is in clean state
        if [ -n "$(git status --porcelain)" ]; then
          echo "‚ö†Ô∏è WARNING: Repository has uncommitted changes"
        fi
        # Validate critical files exist
        if [ ! -f "package.json" ]; then
          echo "‚ùå ERROR: package.json missing"
          exit 1
        fi
        echo "‚úÖ Pre-push validation completed"
