# Prometheus Recording Rules
# Pre-computed metrics for dashboard performance and SLA calculations

groups:
  # Application Performance Recording Rules
  - name: application_performance
    interval: 30s
    rules:
      # Request rate per service (5m window)
      - record: service:http_requests:rate5m
        expr: sum by (service) (rate(http_requests_total[5m]))

      # Error rate per service (5m window)
      - record: service:http_errors:rate5m
        expr: sum by (service) (rate(http_requests_total{status=~"5.."}[5m]))

      # Request latency percentiles (5m window)
      - record: service:http_request_duration_seconds:p50
        expr: histogram_quantile(0.50, sum by (service, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: service:http_request_duration_seconds:p90
        expr: histogram_quantile(0.90, sum by (service, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: service:http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, sum by (service, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: service:http_request_duration_seconds:p99
        expr: histogram_quantile(0.99, sum by (service, le) (rate(http_request_duration_seconds_bucket[5m])))

      # Availability calculation
      - record: service:availability:ratio
        expr: |
          1 - (
            sum by (service) (rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum by (service) (rate(http_requests_total[5m]))
          )

  # SLA Recording Rules
  - name: sla_metrics
    interval: 1m
    rules:
      # Error budget consumption (30 day window)
      - record: sla:error_budget:remaining
        expr: |
          1 - (
            (1 - avg_over_time(service:availability:ratio[30d]))
            /
            (1 - 0.999)
          )

      # SLA compliance percentage
      - record: sla:compliance:percentage
        expr: |
          avg_over_time(service:availability:ratio[30d]) * 100

      # Request success rate (sliding 24h window)
      - record: sla:success_rate:24h
        expr: |
          sum(increase(http_requests_total{status=~"2.."}[24h]))
          /
          sum(increase(http_requests_total[24h]))

  # Database Performance Rules
  - name: database_performance
    interval: 30s
    rules:
      # PostgreSQL connection usage
      - record: postgres:connections:usage_ratio
        expr: |
          pg_stat_activity_count / pg_settings_max_connections

      # PostgreSQL query rate
      - record: postgres:queries:rate5m
        expr: sum(rate(pg_stat_statements_calls[5m]))

      # Redis operations rate
      - record: redis:operations:rate5m
        expr: sum(rate(redis_commands_processed_total[5m]))

      # Redis memory usage ratio
      - record: redis:memory:usage_ratio
        expr: redis_memory_used_bytes / redis_memory_max_bytes

  # Infrastructure Recording Rules
  - name: infrastructure_metrics
    interval: 30s
    rules:
      # CPU usage by instance
      - record: instance:cpu:usage_ratio
        expr: |
          1 - avg by (instance) (
            rate(node_cpu_seconds_total{mode="idle"}[5m])
          )

      # Memory usage by instance
      - record: instance:memory:usage_ratio
        expr: |
          1 - (
            node_memory_MemAvailable_bytes
            /
            node_memory_MemTotal_bytes
          )

      # Disk usage by instance
      - record: instance:disk:usage_ratio
        expr: |
          1 - (
            node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
            /
            node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}
          )

      # Network traffic rate
      - record: instance:network:receive_bytes_rate5m
        expr: rate(node_network_receive_bytes_total[5m])

      - record: instance:network:transmit_bytes_rate5m
        expr: rate(node_network_transmit_bytes_total[5m])

  # Container Metrics Recording Rules
  - name: container_metrics
    interval: 30s
    rules:
      # Container CPU usage
      - record: container:cpu:usage_ratio
        expr: |
          sum by (container_name) (
            rate(container_cpu_usage_seconds_total[5m])
          )

      # Container memory usage
      - record: container:memory:usage_bytes
        expr: |
          container_memory_working_set_bytes

      # Container restart rate
      - record: container:restarts:rate1h
        expr: |
          sum by (container_name) (
            increase(kube_pod_container_status_restarts_total[1h])
          )

  # Business Metrics Recording Rules
  - name: business_metrics
    interval: 1m
    rules:
      # Orders per minute
      - record: business:orders:rate1m
        expr: sum(rate(orders_total[1m])) * 60

      # Revenue per minute
      - record: business:revenue:rate1m
        expr: sum(rate(order_revenue_total[1m])) * 60

      # Active users (5m window)
      - record: business:active_users:count5m
        expr: count(increase(user_activity_total[5m]) > 0)

      # Cart abandonment rate
      - record: business:cart_abandonment:rate
        expr: |
          1 - (
            sum(rate(orders_completed_total[1h]))
            /
            sum(rate(carts_created_total[1h]))
          )

  # Tracing Metrics Recording Rules
  - name: tracing_metrics
    interval: 30s
    rules:
      # Span count rate
      - record: tracing:spans:rate5m
        expr: sum(rate(jaeger_spans_received_total[5m]))

      # Trace error rate
      - record: tracing:errors:rate5m
        expr: |
          sum(rate(jaeger_spans_received_total{error="true"}[5m]))
          /
          sum(rate(jaeger_spans_received_total[5m]))
