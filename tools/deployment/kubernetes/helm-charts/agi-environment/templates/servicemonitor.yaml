{{- if .Values.monitoring.prometheus.enabled -}}
{{- $fullName := include "agi-environment.fullname" . -}}
{{- $labels := include "agi-environment.labels" . -}}
{{- $selectorLabels := include "agi-environment.selectorLabels" . -}}
# ServiceMonitor for Prometheus Operator
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ $fullName }}
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    release: prometheus
spec:
  selector:
    matchLabels:
      {{- $selectorLabels | nindent 6 }}
  endpoints:
    - port: metrics
      path: {{ .Values.monitoring.prometheus.path }}
      interval: {{ .Values.monitoring.prometheus.scrapeInterval }}
      scrapeTimeout: 10s
      honorLabels: true
  namespaceSelector:
    matchNames:
      - {{ .Values.global.namespace | default .Release.Namespace }}
---
# PrometheusRule for alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $fullName }}-alerts
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    release: prometheus
spec:
  groups:
    - name: {{ $fullName }}.rules
      rules:
        # High Error Rate Alert
        - alert: HighErrorRate
          expr: |
            (
              sum(rate(http_requests_total{job="{{ $fullName }}", status=~"5.."}[5m]))
              /
              sum(rate(http_requests_total{job="{{ $fullName }}"}[5m]))
            ) * 100 > 5
          for: 5m
          labels:
            severity: critical
            service: {{ $fullName }}
          annotations:
            summary: "High error rate detected"
            description: "Error rate is above 5% for the last 5 minutes"

        # High Latency Alert
        - alert: HighLatency
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_request_duration_seconds_bucket{job="{{ $fullName }}"}[5m])) by (le)
            ) > 1
          for: 5m
          labels:
            severity: warning
            service: {{ $fullName }}
          annotations:
            summary: "High latency detected"
            description: "95th percentile latency is above 1 second"

        # Pod Not Ready Alert
        - alert: PodNotReady
          expr: |
            kube_pod_status_ready{namespace="{{ .Values.global.namespace | default .Release.Namespace }}",
              pod=~"{{ $fullName }}.*", condition="true"} == 0
          for: 5m
          labels:
            severity: critical
            service: {{ $fullName }}
          annotations:
            summary: "Pod not ready"
            description: "Pod {{ "{{ $labels.pod }}" }} has been not ready for more than 5 minutes"

        # High Memory Usage Alert
        - alert: HighMemoryUsage
          expr: |
            (
              container_memory_usage_bytes{namespace="{{ .Values.global.namespace | default .Release.Namespace }}",
                pod=~"{{ $fullName }}.*", container!="POD"}
              /
              container_spec_memory_limit_bytes{namespace="{{ .Values.global.namespace | default .Release.Namespace }}",
                pod=~"{{ $fullName }}.*", container!="POD"}
            ) * 100 > 85
          for: 5m
          labels:
            severity: warning
            service: {{ $fullName }}
          annotations:
            summary: "High memory usage"
            description: "Memory usage is above 85%"

        # High CPU Usage Alert
        - alert: HighCPUUsage
          expr: |
            (
              sum(rate(container_cpu_usage_seconds_total{namespace="{{ .Values.global.namespace | default .Release.Namespace }}",
                pod=~"{{ $fullName }}.*", container!="POD"}[5m]))
              /
              sum(container_spec_cpu_quota{namespace="{{ .Values.global.namespace | default .Release.Namespace }}",
                pod=~"{{ $fullName }}.*", container!="POD"} / 100000)
            ) * 100 > 85
          for: 5m
          labels:
            severity: warning
            service: {{ $fullName }}
          annotations:
            summary: "High CPU usage"
            description: "CPU usage is above 85%"

        # Pod Restart Alert
        - alert: PodRestarting
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="{{ .Values.global.namespace | default .Release.Namespace }}",
              pod=~"{{ $fullName }}.*"}[1h]) > 3
          for: 5m
          labels:
            severity: warning
            service: {{ $fullName }}
          annotations:
            summary: "Pod restarting frequently"
            description: "Pod {{ "{{ $labels.pod }}" }} has restarted more than 3 times in the last hour"
{{- end }}
